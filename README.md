# Laravel ECommerce

## Environment

-   php
    -   pdo_mysql
-   composer
-   mariadb
-   nodejs
-   npm
-   heroku-cli

## Install Laravel

1. `composer create-project laravel/laravel .`
2. `composer require laravel/ui --dev`
3. (mysql) `create database ECommerce;`
4. Setup _.env_ for database
5. `php artisan migrate`
6. `php artisan ui bootstrap --auth`
7. `npm install && npm run dev`

## Deploy on Heroku

1. `echo "web: vendor/bin/heroku-php-apache2 public/" > Procfile`
2. Push on Heroku
3. `heroku config:set APP_KEY=$(php artisan --no-ansi key:generate --show)`

Reference:

-   [Getting Started with Laravel on Heroku](https://devcenter.heroku.com/articles/getting-started-with-laravel)

## Heroku Cleardb

1. `heroku addons:add cleardb`
2. Get cleardb credential by `heroku config:get CLEARDB_DATABASE_URL`
3. **CLEARDB_DATABASE_URL** is in form of `mysql://username:password@hostname/database_name?reconnect=true`
4. Setup config vars for laravel to access cleardb (copy the credentials and do `heroku config:set DB_CONNECTION=mysql DB_HOST=<host> DB_DATABASE=<DATABASE> DB_USERNAME=<USERNAME> DB_PASSWORD=<PASSWORD>`)
5. `heroku run php artisan migrate`

Reference:

-   [ClearDB MySQL](https://devcenter.heroku.com/articles/cleardb)

## Google Sing-In

_With Socialite, and a bit concept of OAuth, it's no need to study the steps of [Google Sign-In for Websites](https://developers.google.com/identity/sign-in/web/sign-in) or [Using OAuth 2.0 for Web Server Applications](https://developers.google.com/identity/protocols/OAuth2WebServer)_

1. [Google Sign-In for Websites](https://developers.google.com/identity/sign-in/web/sign-in)
    - Client ID
    - Client secret
    - Authorized JavaScript origins (Host URL)
    - Authorized redirect URIs (Callback URL)
2. `composer require laravel/socialite`
3. Setup config vars for google OAuth api by `heroku config:set GOOGLE_CLIENT_ID=<ID> GOOGLE_CLIENT_SECRET=<SECRET>`
4. [Configure](https://laravel.com/docs/6.x/socialite#configuration) credentials for google OAuth api
5. `php artisan make:controller Oauth/SocialiteController`
6. Setup routes for google OAuth sign in and callback. For OAuth, there are lots of providers, so I decide to put a route parameter for determine which provider to use.
    - Forgive the chance that entering unimplemented provider cause 5xx for code clearance.
7. `php artisan make:migration create_oauth_accounts_table`
8. `php artisan make:model Auth/OauthAccount`
9. Record **sub** and **provider** when login with OAuth

## Integrate Google Sign-in into authentication flow

Move Eloquent models to a dedicate directory _app/Eloquent_.
**\App\User renamed to \App\Eloquent\Auth\User**. It's important to also modify user provider configuration in _config/auth.php_

Because a user can be create by OAuth login, email(username) and password can be null.
A user can associate with multiple OAuth account (with different OAuth provider).
It's a one-to-many relationship.

1. Write a new method for `User` model to retrieve its `oauthAccount`s
2. Write a new method for `oauthAccount`s account to retrieve its `User`

OAuth login scenarios:

|                    | New user             | Logged in by credentials   |
| ------------------ | -------------------- | -------------------------- |
| New OAuth account  | Create OAuth account | Link OAuth to current user |
| Logged in by OAuth | Login user           | N/A                        |

## Item

`php artisan make:model -cmr Eloquent/Item`
`php artisan make:request StoreItemRequest`
`php artisan make:request UpdateItemRequest`

> Laravel will automatically redirect the user back to their previous location
>
> -- [Laravel](https://laravel.com/docs/master/validation#quick-displaying-the-validation-errors)

-   `old()` to get previously input value

## spatie/laravel-permission

`composer require spatie/laravel-permission`
`php artisan vendor:publish --provider="Spatie\Permission\PermissionServiceProvider"`
`php artisan migrate`
`use HasRoles` in User model (_app/Eloquent/Auth/User.php_)

## Roles

-   super_admin
-   admin
-   client

Super admin is generated by seeding

### Have users a default role client

Add listener for assigning default role to new user.

```php
<?php

namespace App/Providers;

class EventServiceProvider extends ServiceProvider
{
    protected $listen = [
        \App\Events\UserCreatedEvent::class => [
            \App\Listeners\AssignDefaultRoleToNewUserListener::class,
        ],
    ];
}
```

`php artisan event:generate` create classes in `$listen` for us

Dispatch event `\App\Events\UserCreatedEvent::class` by Eloquent event.

```php
<?php

namespace App\Eloquent\Auth;

class User extends Authenticatable{
    protected $dispatchesEvents = [
        'created' => \App\Events\UserCreatedEvent::class,
    ];
}
```

## Permissions

Permission name convention for resource:

-   `<resource>.index`
-   `<resource>.create`
-   `<resource>.show`
-   `<resource>.edit`
-   `<resource>.destory`

`php artisan make:controller -rm 'App\Eloquent\Auth\User' UserController`
`php artisan make:migration AddUserInfoFieldsToUsersTable`

## View composer

## Testing

```sh
cp .env.testing.example .env.testing
php artisan --env=testing key:generate
```

## Troubleshooting

### `php artisan make:auth`: Command "make:auth" is not defined

Laravel 6 separates authentication to a dedicate package **laravel/ui**.
Install **laravel/ui** and run `php artisan ui:auth` instead.

### `php artisan migrate`: could not find driver

Install and configure extension **pdo_mysql** for php.

### SQLSTATE: 1071 Specified key was too long

Calling the `Schema::defaultStringLength` method within your `AppServiceProvider@boot`

Reference: https://laravel.com/docs/master/migrations#creating-indexes

## Tips

-   Follow [laravel best practices](https://github.com/alexeymezenin/laravel-best-practices)

### Heroku

-   To omit `--app` option for heroku cli commands, add a git remote points to **Heroku Git URL** of the app. [Reference](https://stackoverflow.com/questions/55470675/how-to-avoid-the-app-option-with-heroku-cli)
-   **Config Vars** are equivalent to key-values in _.env_ file.

## Notes

-   > If validation fails, a redirect response will be generated to send the user back to their previous location. The errors will also be flashed to the session so they are available for display.
    >
    > -- [Form Request Validation](https://laravel.com/docs/6.x/validation#form-request-validation)

    Laravel get previous location by **referrer** in http header.
    [>>trace code](https://github.com/laravel/framework/blob/15d67444846c712b6bec7db86e0647dc721c188f/src/Illuminate/Foundation/Exceptions/Handler.php#L274)
    [>>trace code](https://github.com/laravel/framework/blob/15d67444846c712b6bec7db86e0647dc721c188f/src/Illuminate/Routing/UrlGenerator.php#L156)

## Problems

-   Not sure if we should version control compiled css and js files,
    that is, files in _public/css_ and _public/js_
-   Why register middlewares to `$routeMiddleware` and then assign to a route? Why not just assign middlewares with it's full name?
